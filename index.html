<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂáΩÊï∞ÂØºÊï∞Ê∂àÊ∂à‰πê - Â•ñÂä±È°µÈù¢</title>
    <style>
        /* Âä†ËΩΩÊåáÁ§∫Âô® */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            z-index: 9999;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }

        .loading-indicator.loaded {
            transform: scaleX(1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        *:focus {
            outline: none;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Âä®ÊÄÅËÉåÊôØÁ≤íÂ≠ê */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 15s infinite ease-in-out;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(50px);
                opacity: 0;
            }
        }

        /* ÁàÜÁÇ∏Á≤íÂ≠êÊïàÊûú */
        .explosion {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
        }

        .explosion-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
            animation: explode 0.6s ease-out forwards;
        }

        @keyframes explode {
            0% {
                transform: scale(1) translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: scale(0) translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            position: relative;
            z-index: 1;
            animation: slideIn 0.5s ease-out;
            will-change: transform;
            contain: layout style paint;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .info-value.animate {
            animation: scorePop 0.5s ease;
        }

        @keyframes scorePop {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
                color: #ffd700;
            }
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            transform: translateZ(0);
        }

        .cell {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            padding: 8px;
            text-align: center;
            line-height: 1.2;
            animation: cardAppear 0.5s ease-out backwards;
            transform-style: preserve-3d;
            perspective: 1000px;
            will-change: transform;
            contain: layout style paint;
            transform: translateZ(0);
        }
        
        /* ÂéüÂáΩÊï∞ÂçïÂÖÉÊ†ºÊ†∑Âºè - ËìùËâ≤Â∫ïËâ≤ */
        .cell[data-type='func'] {
            background: linear-gradient(135deg, #1e90ff 0%, #00bfff 100%);
        }
        
        /* ÂØºÊï∞ÂçïÂÖÉÊ†ºÊ†∑Âºè - Á∫¢Ëâ≤Â∫ïËâ≤ */
        .cell[data-type='derivative'] {
            background: linear-gradient(135deg, #ff6347 0%, #ff4500 100%);
        }

        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: scale(0.8) rotateY(180deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }

        .cell::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .cell:hover::before {
            opacity: 1;
        }

        .cell sup {
            font-size: 0.55em;
            vertical-align: super;
            line-height: 0;
            position: relative;
            top: -0.4em;
            font-weight: normal;
        }

        .cell sup sup {
            font-size: 0.9em;
            top: 0;
        }

        .cell .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            font-size: 0.9em;
        }

        .cell .fraction .numerator {
            display: block;
            border-bottom: 1.5px solid white;
            padding-bottom: 2px;
            margin-bottom: 2px;
            line-height: 1.2;
            position: relative;
        }

        .cell .fraction .denominator {
            display: block;
            line-height: 1.2;
            padding-top: 1px;
        }

        .cell .fraction sup {
            font-size: 0.6em;
            top: -0.4em;
            line-height: 0;
            position: relative;
        }

        .cell .fraction .numerator sup {
            top: -0.5em;
        }

        .cell .fraction .denominator sup {
            top: -0.3em;
        }

        .cell .sqrt {
            position: relative;
            display: inline-flex;
            align-items: center;
            padding-left: 12px;
            margin: 0 2px;
            vertical-align: middle;
            white-space: nowrap;
        }

        .cell .sqrt::before {
            content: '‚àö';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.4em;
            line-height: 1;
            font-weight: normal;
            z-index: 1;
            display: inline-block;
            width: auto;
            height: auto;
        }

        .cell .sqrt::after {
            content: '';
            position: absolute;
            left: 0.6em;
            top: 0.05em;
            right: 0;
            height: 1px;
            background: white;
            z-index: 0;
        }

        .cell .sqrt-content {
            border-top: none;
            padding: 0 4px;
            display: inline-block;
            margin-left: 3px;
            position: relative;
            z-index: 2;
            min-height: 1em;
            line-height: 1.2;
            vertical-align: baseline;
        }

        .cell:hover {
            transform: scale(1.05) translateZ(10px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 0 20px rgba(102, 126, 234, 0.4);
        }

        .cell:active {
            transform: scale(0.95);
        }

        .cell.selected {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3), 0 0 20px rgba(240, 147, 251, 0.6);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3), 0 0 20px rgba(240, 147, 251, 0.6);
            }
            50% {
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3), 0 0 30px rgba(240, 147, 251, 0.9);
            }
        }

        .cell.matched {
            animation: disappear 0.5s ease forwards, matchGlow 0.5s ease;
        }

        @keyframes matchGlow {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
            }
            50% {
                box-shadow: 0 0 30px 10px rgba(255, 215, 0, 0.7);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        .cell.hidden {
            opacity: 0;
            pointer-events: none;
        }

        @keyframes disappear {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.5;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .message {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: bold;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(59, 178, 184, 0.3);
        }

        .round-complete {
            text-align: center;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #856404;
            font-weight: bold;
        }

        .game-complete {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .game-complete h2 {
            font-size: 32px;
            margin-bottom: 15px;
            animation: celebrate 1s ease-in-out infinite;
        }

        @keyframes celebrate {
            0%, 100% {
                transform: scale(1) rotate(0deg);
            }
            25% {
                transform: scale(1.1) rotate(-5deg);
            }
            75% {
                transform: scale(1.1) rotate(5deg);
            }
        }

        .game-complete p {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .health-bar-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .health-label {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .health-bar {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .health-heart {
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .health-heart.full {
            color: #ff4757;
        }

        .health-heart.empty {
            color: #ddd;
            transform: scale(0.8);
        }

        .game-failed {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border-radius: 10px;
            color: white;
        }

        .game-failed h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        .game-failed p {
            font-size: 18px;
            margin-bottom: 30px;
        }

        /* ËøûÂáªÊèêÁ§∫ */
        .combo-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 2000;
            animation: comboPop 0.8s ease-out forwards;
            display: none;
        }

        @keyframes comboPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) translateY(-100px);
                opacity: 0;
            }
        }

        /* ÂºÄÂßãÁïåÈù¢ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: fadeIn 0.5s ease;
        }

        .start-screen.hidden {
            animation: fadeOut 0.5s ease forwards;
            pointer-events: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .start-content {
            text-align: center;
            color: white;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .start-title {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
        }

        .start-subtitle {
            font-size: 20px;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .start-button {
            padding: 18px 50px;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid white;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .start-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* ÊàêÂ∞±ÂæΩÁ´† */
        .achievement-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 215, 0, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            color: #333;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: badgeSlide 0.5s ease-out;
            display: none;
        }

        @keyframes badgeSlide {
            from {
                transform: translateX(200px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ËøõÂ∫¶Êù° */
        .progress-bar-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* ÂÖ≥Âç°ÈÄâÊã©ÁïåÈù¢ */
        .level-select-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.5s ease;
        }

        .level-select-screen.hidden {
            display: none;
        }

        .level-select-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .level-select-title {
            text-align: center;
            color: #667eea;
            font-size: 32px;
            margin-bottom: 30px;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .level-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .level-card.locked {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .level-card.locked:hover {
            transform: none;
        }

        .level-card.completed {
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
        }

        .level-number {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-name {
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .level-description {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .level-status {
            font-size: 12px;
            margin-top: 10px;
        }

        .level-lock-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }

        .back-button {
            text-align: center;
        }

        .back-button button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-button button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        /* Ê∏∏Êàè‰∏≠ÁöÑËøîÂõûÊåâÈíÆ */
        .game-back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        .game-back-button button {
            padding: 10px 16px;
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .game-back-button button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
        }

        /* Â•ñÂä±È°µÈù¢Ê†∑Âºè */
        .reward-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            animation: fadeIn 0.5s ease;
        }

        .reward-screen.hidden {
            display: none;
        }

        .reward-container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.8s ease-out;
        }

        .reward-title {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 30px;
            animation: celebrate 2s ease-in-out infinite;
        }

        .reward-subtitle {
            font-size: 24px;
            color: #764ba2;
            margin-bottom: 20px;
        }

        .reward-emoji {
            font-size: 60px;
            margin: 30px 0;
            animation: emojiFloat 3s ease-in-out infinite;
        }

        @keyframes emojiFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            25% {
                transform: translateY(-10px) rotate(-5deg);
            }
            75% {
                transform: translateY(-5px) rotate(5deg);
            }
        }

        .reward-message {
            font-size: 18px;
            line-height: 1.6;
            color: #666;
            margin-bottom: 30px;
        }

        .reward-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 15px;
        }

        .reward-stat {
            text-align: center;
        }

        .reward-stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .reward-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .reward-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .reward-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
        }

        .reward-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .reward-button.share {
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° - ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media screen and (max-width: 768px) {
            /* Èò≤Ê≠¢ÊñáÊú¨ÈÄâÊã©Ôºå‰ºòÂåñËß¶Êë∏‰ΩìÈ™å */
            .cell,
            .button,
            .action-button,
            .level-card,
            .start-button,
            .reward-button {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }

            /* Á¶ÅÁî®ÁßªÂä®Á´ØhoverÊïàÊûú */
            .cell:hover {
                transform: none;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .cell:active {
                transform: scale(0.95);
            }

            .button:hover,
            .action-button:hover,
            .start-button:hover,
            .back-button button:hover,
            .game-back-button button:hover,
            .reward-button:hover {
                transform: none;
            }

            .button:active,
            .action-button:active,
            .start-button:active,
            .back-button button:active,
            .game-back-button button:active,
            .reward-button:active {
                transform: scale(0.95);
            }

            .level-card:hover {
                transform: none;
            }

            .level-card:active {
                transform: scale(0.98);
            }

            body {
                padding: 10px;
            }

            .game-container {
                padding: 15px 10px;
                border-radius: 15px;
                max-width: 100%;
            }

            h1 {
                font-size: 22px;
                margin-bottom: 8px;
            }

            .game-header {
                margin-bottom: 15px;
            }

            .game-info {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px;
                margin-bottom: 12px;
            }

            .info-item {
                flex: 1 1 calc(50% - 5px);
                min-width: calc(50% - 5px);
            }

            .info-label {
                font-size: 11px;
                margin-bottom: 3px;
            }

            .info-value {
                font-size: 16px;
            }

            .game-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                margin-bottom: 15px;
            }

            .cell {
                font-size: 10px;
                padding: 4px;
                border-radius: 6px;
            }

            .cell .fraction {
                font-size: 0.75em;
            }

            .cell .fraction .numerator {
                line-height: 1.3;
                padding-bottom: 2px;
                margin-bottom: 2px;
            }

            .cell .fraction .denominator {
                line-height: 1.3;
                padding-top: 2px;
            }

            .cell .fraction sup {
                font-size: 0.65em;
                line-height: 0;
                position: relative;
            }

            .cell .fraction .numerator sup {
                top: -0.6em;
            }

            .cell .fraction .denominator sup {
                top: -0.4em;
            }

            .cell .sqrt {
                padding-left: 8px;
            }

            .cell .sqrt::before {
                font-size: 1.1em;
            }

            .cell .sqrt::after {
                left: 0.4em;
                top: 0.18em;
                height: 0.8px;
            }

            .cell .sqrt-content {
                border-top: none;
                padding: 0 2px;
                margin-left: 2px;
            }

            .message {
                padding: 12px;
                margin-bottom: 15px;
                min-height: 40px;
                font-size: 14px;
            }

            .button {
                padding: 12px;
                font-size: 16px;
            }

            .action-button {
                padding: 8px 16px;
                font-size: 14px;
            }

            .health-bar-container {
                padding: 10px;
                margin-bottom: 12px;
            }

            .health-label {
                font-size: 12px;
                margin-bottom: 6px;
            }

            .health-heart {
                font-size: 20px;
            }

            .progress-bar-container {
                padding: 10px;
                margin-bottom: 12px;
            }

            .start-title {
                font-size: 32px;
                margin-bottom: 15px;
            }

            .start-subtitle {
                font-size: 16px;
                margin-bottom: 30px;
            }

            .start-button {
                padding: 14px 35px;
                font-size: 20px;
            }

            .level-select-container {
                padding: 25px 20px;
                width: 95%;
                max-height: 95vh;
            }

            .level-select-title {
                font-size: 24px;
                margin-bottom: 20px;
            }

            .level-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }

            .level-card {
                padding: 20px 15px;
                border-radius: 12px;
            }

            .level-number {
                font-size: 36px;
                margin-bottom: 8px;
            }

            .level-name {
                font-size: 16px;
                margin-bottom: 8px;
            }

            .level-description {
                font-size: 12px;
                margin-bottom: 10px;
            }

            .level-status {
                font-size: 11px;
            }

            .level-lock-icon {
                font-size: 20px;
            }

            .game-back-button {
                top: 10px;
                left: 10px;
            }

            .game-back-button button {
                padding: 8px 12px;
                font-size: 13px;
                border-radius: 6px;
            }

            .game-complete {
                padding: 20px;
            }

            .game-complete h2 {
                font-size: 24px;
                margin-bottom: 12px;
            }

            .game-complete p {
                font-size: 16px;
                margin-bottom: 15px;
            }

            .game-failed {
                padding: 25px;
            }

            .game-failed h2 {
                font-size: 22px;
                margin-bottom: 15px;
            }

            .game-failed p {
                font-size: 16px;
                margin-bottom: 20px;
            }

            .combo-indicator {
                font-size: 36px;
            }

            .achievement-badge {
                top: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 14px;
            }

            .back-button button {
                padding: 10px 25px;
                font-size: 14px;
            }

            /* Â•ñÂä±È°µÈù¢ÂìçÂ∫îÂºè */
            .reward-container {
                padding: 30px 20px;
            }

            .reward-title {
                font-size: 28px;
                margin-bottom: 20px;
            }

            .reward-subtitle {
                font-size: 20px;
                margin-bottom: 15px;
            }

            .reward-emoji {
                font-size: 48px;
                margin: 20px 0;
            }

            .reward-message {
                font-size: 16px;
                margin-bottom: 20px;
            }

            .reward-stats {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
                margin-bottom: 20px;
            }

            .reward-actions {
                flex-direction: column;
            }

            .reward-button {
                width: 100%;
                max-width: none;
            }
        }

        @media screen and (max-width: 480px) {
            body {
                padding: 5px;
            }

            .game-container {
                padding: 12px 8px;
                border-radius: 12px;
            }

            h1 {
                font-size: 20px;
            }

            .game-info {
                padding: 10px;
                gap: 8px;
            }

            .info-item {
                flex: 1 1 calc(50% - 4px);
                min-width: calc(50% - 4px);
            }

            .info-label {
                font-size: 10px;
            }

            .info-value {
                font-size: 14px;
            }

            .game-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }

            .cell {
                font-size: 9px;
                padding: 3px;
            }

            .cell .fraction {
                font-size: 0.7em;
            }

            .cell .fraction .numerator {
                line-height: 1.4;
                padding-bottom: 2px;
                margin-bottom: 2px;
            }

            .cell .fraction .denominator {
                line-height: 1.4;
                padding-top: 2px;
            }

            .cell .fraction sup {
                font-size: 0.7em;
                line-height: 0;
                position: relative;
            }

            .cell .fraction .numerator sup {
                top: -0.7em;
            }

            .cell .fraction .denominator sup {
                top: -0.5em;
            }

            .cell .sqrt {
                padding-left: 6px;
            }

            .cell .sqrt::before {
                font-size: 1em;
            }

            .cell .sqrt::after {
                left: 0.35em;
                top: 0.16em;
                height: 0.7px;
            }

            .cell .sqrt-content {
                border-top: none;
                padding: 0 2px;
                margin-left: 2px;
            }

            .message {
                padding: 10px;
                font-size: 13px;
            }

            .start-title {
                font-size: 28px;
            }

            .start-subtitle {
                font-size: 14px;
            }

            .start-button {
                padding: 12px 30px;
                font-size: 18px;
            }

            .level-select-container {
                padding: 20px 15px;
            }

            .level-select-title {
                font-size: 20px;
            }

            .level-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .level-card {
                padding: 18px 12px;
            }

            .level-number {
                font-size: 32px;
            }

            .level-name {
                font-size: 15px;
            }

            .level-description {
                font-size: 11px;
            }

            .game-back-button {
                top: 8px;
                left: 8px;
            }

            .game-back-button button {
                padding: 6px 10px;
                font-size: 12px;
                border-radius: 5px;
            }

            .combo-indicator {
                font-size: 28px;
            }

            /* Â•ñÂä±È°µÈù¢ÂìçÂ∫îÂºè */
            .reward-container {
                padding: 25px 15px;
            }

            .reward-title {
                font-size: 24px;
            }

            .reward-subtitle {
                font-size: 18px;
            }

            .reward-emoji {
                font-size: 40px;
            }

            .reward-message {
                font-size: 14px;
            }
        }

        /* Ê®™Â±èÊ®°Âºè‰ºòÂåñ */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .game-container {
                max-height: 95vh;
                overflow-y: auto;
                padding: 10px 8px;
            }

            .game-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 5px;
            }

            .cell {
                font-size: 9px;
                padding: 3px;
            }

            .game-header {
                margin-bottom: 10px;
            }

            .game-info {
                padding: 8px;
                margin-bottom: 10px;
            }

            .health-bar-container,
            .progress-bar-container {
                padding: 8px;
                margin-bottom: 10px;
            }

            .level-select-container {
                max-height: 95vh;
            }

            .start-title {
                font-size: 28px;
                margin-bottom: 10px;
            }

            .start-subtitle {
                font-size: 14px;
                margin-bottom: 20px;
            }

            .start-button {
                padding: 10px 30px;
                font-size: 18px;
            }

            /* Â•ñÂä±È°µÈù¢Ê®™Â±è‰ºòÂåñ */
            .reward-container {
                max-height: 95vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
    <div class="loading-indicator" id="loadingIndicator"></div>
    
    <!-- Âä®ÊÄÅËÉåÊôØÁ≤íÂ≠ê -->
    <div class="particles" id="particles"></div>

    <!-- ÂºÄÂßãÁïåÈù¢ -->
    <div class="start-screen" id="startScreen">
        <div class="start-content">
            <h1 class="start-title">üßÆ ÂáΩÊï∞ÂØºÊï∞Ê∂àÊ∂à‰πê</h1>
            <p class="start-subtitle">ÊåëÊàò‰Ω†ÁöÑÊï∞Â≠¶Áü•ËØÜÔºåÂåπÈÖçÂáΩÊï∞‰∏éÂØºÊï∞ÔºÅ</p>
            <button class="start-button" id="startButton">ÂºÄÂßãÊ∏∏Êàè</button>
        </div>
    </div>

    <!-- ÂÖ≥Âç°ÈÄâÊã©ÁïåÈù¢ -->
    <div class="level-select-screen" id="levelSelectScreen">
        <div class="level-select-container">
            <h2 class="level-select-title">ÈÄâÊã©ÂÖ≥Âç°</h2>
            <div class="level-grid" id="levelGrid"></div>
            <div class="back-button">
                <button id="backToStartBtn">ËøîÂõû</button>
            </div>
        </div>
    </div>

    <!-- Â•ñÂä±È°µÈù¢ -->
    <div class="reward-screen hidden" id="rewardScreen">
        <div class="reward-container">
            <h1 class="reward-title">üéâ ÊÅ≠ÂñúÊÇ®ÔºÅËé∑ÂæóÂØºÊï∞ËøêÁÆóËææ‰∫∫Áß∞Âè∑ üéâ</h1>
            <div class="reward-emoji">üèÜü•áüéìüß†üìö‚ú®</div>
            <p class="reward-subtitle">ÊÇ®Â∑≤ÊàêÂäüÈÄöÂÖ≥ÊâÄÊúâÂÖ≥Âç°ÔºÅ</p>
            <p class="reward-message">ÊÇ®ÁöÑÊï∞Â≠¶ÊâçËÉΩ‰ª§‰∫∫ÊÉäÂèπÔºÅÈÄöËøá‰∏çÊáàÂä™ÂäõÔºåÊÇ®Â∑≤ÊéåÊè°‰∫ÜÂáΩÊï∞Ê±ÇÂØºÁöÑÊ†∏ÂøÉÊäÄÂ∑ßÔºåÊàê‰∏∫‰∫ÜÁúüÊ≠£ÁöÑÂØºÊï∞ËøêÁÆóËææ‰∫∫ÔºÅ</p>
            
            <div class="reward-stats">
                <div class="reward-stat">
                    <div class="reward-stat-label">ÈÄöÂÖ≥ÂÖ≥Âç°</div>
                    <div class="reward-stat-value" id="rewardLevels">4/4</div>
                </div>
                <div class="reward-stat">
                    <div class="reward-stat-label">ÊÄªÂæóÂàÜ</div>
                    <div class="reward-stat-value" id="rewardScore">0</div>
                </div>
                <div class="reward-stat">
                    <div class="reward-stat-label">ÊÄªÁî®Êó∂</div>
                    <div class="reward-stat-value" id="rewardTime">00:00</div>
                </div>
            </div>
            
            <div class="reward-actions">
                <button class="reward-button share" id="shareButton">ÂàÜ‰∫´ÊàêÂ∞±</button>
                <button class="reward-button" id="rewardBackButton">ËøîÂõûÂÖ≥Âç°</button>
            </div>
        </div>
    </div>

    <!-- ËøûÂáªÊèêÁ§∫ -->
    <div class="combo-indicator" id="comboIndicator"></div>

    <!-- ÊàêÂ∞±ÂæΩÁ´† -->
    <div class="achievement-badge" id="achievementBadge"></div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <div class="game-back-button">
            <button id="gameBackToLevelBtn">&lt; ËøîÂõû</button>
        </div>
        <div class="game-header">
            <h1>üßÆ ÂáΩÊï∞ÂØºÊï∞Ê∂àÊ∂à‰πê</h1>
        </div>

        <div class="health-bar-container">
            <div class="health-label">ÁîüÂëΩÂÄº</div>
            <div class="health-bar" id="healthBar">
                <span class="health-heart full">‚ù§Ô∏è</span>
                <span class="health-heart full">‚ù§Ô∏è</span>
                <span class="health-heart full">‚ù§Ô∏è</span>
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="game-info">
            <div class="info-item">
                <div class="info-label">ÂΩìÂâçÂÖ≥Âç°</div>
                <div class="info-value" id="level">ÂÖ≥Âç° 1</div>
            </div>
            <div class="info-item">
                <div class="info-label">Ââ©‰ΩôÈÖçÂØπ</div>
                <div class="info-value" id="remaining">8</div>
            </div>
            <div class="info-item">
                <div class="info-label">Áî®Êó∂</div>
                <div class="info-value" id="timer">00:00</div>
            </div>
            <div class="info-item">
                <div class="info-label">ÂæóÂàÜ</div>
                <div class="info-value" id="score">0</div>
            </div>
        </div>

        <div class="message info" id="message">ÁÇπÂáªÂáΩÊï∞ÂíåÂÖ∂ÂØπÂ∫îÁöÑÂØºÊï∞ËøõË°åÈÖçÂØπÊ∂àÈô§</div>
        <div class="round-description" id="roundDescription" style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;"></div>
        <div class="action-buttons">
            <button class="action-button" id="continueBtn">ÁªßÁª≠‰ΩúÁ≠î</button>
            <button class="action-button" id="retryRoundBtn">ÈáçÊñ∞‰ΩúÁ≠î</button>
        </div>

        <div class="game-grid" id="gameGrid"></div>

        <button class="button" id="backToLevelBtn" style="display: none;">ËøîÂõûÂÖ≥Âç°ÈÄâÊã©</button>
        <button class="button" id="restartBtn" style="display: none;">ÈáçÊñ∞ÂºÄÂßã</button>
    </div>

    <script>
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÁä∂ÊÄÅ
        let isPageLoaded = false;
        
        // ÊòæÁ§∫Âä†ËΩΩËøõÂ∫¶
        window.addEventListener('load', function() {
            const loader = document.getElementById('loadingIndicator');
            if (loader) {
                loader.classList.add('loaded');
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }
            isPageLoaded = true;
        });

        // ÂÖ≥Âç°Êï∞ÊçÆ
        const LEVELS = [
            {
                id: 1,
                name: 'Âü∫Êú¨ÂàùÁ≠âÂáΩÊï∞Ê±ÇÂØº',
                description: 'ÊéåÊè°Âü∫Êú¨ÂàùÁ≠âÂáΩÊï∞ÁöÑÊ±ÇÂØºÊ≥ïÂàô',
                pairs: [
                    // ÂπÇÂáΩÊï∞Ôºà‰∏çÂêåÊ¨°Êï∞Ôºâ
                    { func: 'y=x', derivative: '1' },
                    { func: 'y=x<sup>2</sup>', derivative: '2x' },
                    { func: 'y=x<sup>3</sup>', derivative: '3x<sup>2</sup>' },
                    { func: 'y=x<sup>4</sup>', derivative: '4x<sup>3</sup>' },
                    { func: 'y=x<sup>5</sup>', derivative: '5x<sup>4</sup>' },
                    { func: 'y=x<sup>6</sup>', derivative: '6x<sup>5</sup>' },
                    { func: 'y=2x', derivative: '2' },
                    { func: 'y=3x', derivative: '3' },
                    { func: 'y=2x<sup>2</sup>', derivative: '4x' },
                    { func: 'y=3x<sup>2</sup>', derivative: '6x' },
                    { func: 'y=2x<sup>3</sup>', derivative: '6x<sup>2</sup>' },
                    { func: 'y=3x<sup>3</sup>', derivative: '9x<sup>2</sup>' },
                    // ‰∏âËßíÂáΩÊï∞
                    { func: 'y=sinx', derivative: 'cosx' },
                    { func: 'y=cosx', derivative: '-sinx' },
                    { func: 'y=tanx', derivative: 'sec<sup>2</sup>x' },
                    { func: 'y=2sinx', derivative: '2cosx' },
                    { func: 'y=3sinx', derivative: '3cosx' },
                    { func: 'y=2cosx', derivative: '-2sinx' },
                    { func: 'y=3cosx', derivative: '-3sinx' },
                    // ÊåáÊï∞ÂíåÂØπÊï∞ÂáΩÊï∞
                    { func: 'y=e<sup>x</sup>', derivative: 'e<sup>x</sup>' },
                    { func: 'y=2e<sup>x</sup>', derivative: '2e<sup>x</sup>' },
                    { func: 'y=3e<sup>x</sup>', derivative: '3e<sup>x</sup>' },
                    { func: 'y=lnx', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator">x</span></span>' },
                    { func: 'y=2lnx', derivative: '<span class="fraction"><span class="numerator">2</span><span class="denominator">x</span></span>' },
                    { func: 'y=3lnx', derivative: '<span class="fraction"><span class="numerator">3</span><span class="denominator">x</span></span>' },
                    // Ê†πÂºèÂíåÂàÜÂºè
                    { func: 'y=<span class="sqrt"><span class="sqrt-content">x</span></span>', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator">2<span class="sqrt"><span class="sqrt-content">x</span></span></span></span>' },
                    { func: 'y=2<span class="sqrt"><span class="sqrt-content">x</span></span>', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator"><span class="sqrt"><span class="sqrt-content">x</span></span></span></span>' },
                    { func: 'y=3<span class="sqrt"><span class="sqrt-content">x</span></span>', derivative: '<span class="fraction"><span class="numerator">3</span><span class="denominator">2<span class="sqrt"><span class="sqrt-content">x</span></span></span></span>' },
                    { func: 'y=<span class="fraction"><span class="numerator">1</span><span class="denominator">x</span></span>', derivative: '-<span class="fraction"><span class="numerator">1</span><span class="denominator">x<sup>2</sup></span></span>' },
                    { func: 'y=<span class="fraction"><span class="numerator">1</span><span class="denominator">x<sup>2</sup></span></span>', derivative: '-<span class="fraction"><span class="numerator">2</span><span class="denominator">x<sup>3</sup></span></span>' },
                    { func: 'y=<span class="fraction"><span class="numerator">1</span><span class="denominator">x<sup>3</sup></span></span>', derivative: '-<span class="fraction"><span class="numerator">3</span><span class="denominator">x<sup>4</sup></span></span>' }
                ]
            },
            {
                id: 2,
                name: 'ÂõõÂàôËøêÁÆóÊ±ÇÂØº',
                description: 'Âü∫Êú¨ÂàùÁ≠âÂáΩÊï∞ÁöÑÂõõÂàôËøêÁÆóÊ±ÇÂØºÊ≥ïÂàô',
                pairs: [
                    // Âä†ÂáèËøêÁÆó
                    { func: 'y=sinx+cosx', derivative: 'cosx-sinx' },
                    { func: 'y=x<sup>2</sup>+x<sup>3</sup>', derivative: '2x+3x<sup>2</sup>' },
                    { func: 'y=x<sup>3</sup>+x<sup>4</sup>', derivative: '3x<sup>2</sup>+4x<sup>3</sup>' },
                    { func: 'y=x<sup>2</sup>+x', derivative: '2x+1' },
                    { func: 'y=e<sup>x</sup>-lnx', derivative: 'e<sup>x</sup>-<span class="fraction"><span class="numerator">1</span><span class="denominator">x</span></span>' },
                    { func: 'y=x<sup>2</sup>-x<sup>3</sup>', derivative: '2x-3x<sup>2</sup>' },
                    { func: 'y=2x<sup>2</sup>+3x', derivative: '4x+3' },
                    { func: 'y=3x<sup>2</sup>-2x', derivative: '6x-2' },
                    { func: 'y=2sinx+3cosx', derivative: '2cosx-3sinx' },
                    // ‰πòÊ≥ïËøêÁÆó
                    { func: 'y=x¬∑sinx', derivative: 'sinx+x¬∑cosx' },
                    { func: 'y=x¬∑cosx', derivative: 'cosx-x¬∑sinx' },
                    { func: 'y=x¬∑lnx', derivative: 'lnx+1' },
                    { func: 'y=x<sup>2</sup>¬∑sinx', derivative: '2x¬∑sinx+x<sup>2</sup>¬∑cosx' },
                    { func: 'y=x<sup>3</sup>¬∑e<sup>x</sup>', derivative: '3x<sup>2</sup>¬∑e<sup>x</sup>+x<sup>3</sup>¬∑e<sup>x</sup>' },
                    { func: 'y=3x¬∑sinx', derivative: '3sinx+3x¬∑cosx' },
                    { func: 'y=2x¬∑cosx', derivative: '2cosx-2x¬∑sinx' },
                    { func: 'y=3x<sup>2</sup>¬∑sinx', derivative: '6x¬∑sinx+3x<sup>2</sup>¬∑cosx' },
                    { func: 'y=2x<sup>3</sup>¬∑e<sup>x</sup>', derivative: '6x<sup>2</sup>¬∑e<sup>x</sup>+2x<sup>3</sup>¬∑e<sup>x</sup>' },
                    // Èô§Ê≥ïËøêÁÆóÔºàÁÆÄÂåñÔºâ
                    { func: 'y=<span class="fraction"><span class="numerator">x</span><span class="denominator">x+1</span></span>', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator">(x+1)<sup>2</sup></span></span>' },
                    { func: 'y=<span class="fraction"><span class="numerator">x</span><span class="denominator">x+2</span></span>', derivative: '<span class="fraction"><span class="numerator">2</span><span class="denominator">(x+2)<sup>2</sup></span></span>' },
                    { func: 'y=<span class="fraction"><span class="numerator">sinx</span><span class="denominator">x</span></span>', derivative: '<span class="fraction"><span class="numerator">x¬∑cosx-sinx</span><span class="denominator">x<sup>2</sup></span></span>' },
                    { func: 'y=<span class="fraction"><span class="numerator">2x</span><span class="denominator">x+1</span></span>', derivative: '<span class="fraction"><span class="numerator">2</span><span class="denominator">(x+1)<sup>2</sup></span></span>' },
                    { func: 'y=<span class="fraction"><span class="numerator">3x</span><span class="denominator">x+2</span></span>', derivative: '<span class="fraction"><span class="numerator">3</span><span class="denominator">(x+2)<sup>2</sup></span></span>' }
                ]
            },
            {
                id: 3,
                name: 'Â§çÂêàÂáΩÊï∞Ê±ÇÂØº',
                description: 'ÊéåÊè°Â§çÂêàÂáΩÊï∞ÁöÑÈìæÂºèÊ±ÇÂØºÊ≥ïÂàô',
                pairs: [
                    { func: 'y=sin(2x)', derivative: '2cos(2x)' },
                    { func: 'y=cos(3x)', derivative: '-3sin(3x)' },
                    { func: 'y=sin(x<sup>2</sup>)', derivative: '2x¬∑cos(x<sup>2</sup>)' },
                    { func: 'y=cos(x<sup>2</sup>)', derivative: '-2x¬∑sin(x<sup>2</sup>)' },
                    { func: 'y=e<sup>2x</sup>', derivative: '2e<sup>2x</sup>' },
                    { func: 'y=e<sup>3x</sup>', derivative: '3e<sup>3x</sup>' },
                    { func: 'y=e<sup>x<sup>2</sup></sup>', derivative: '2x¬∑e<sup>x<sup>2</sup></sup>' },
                    { func: 'y=ln(2x)', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator">x</span></span>' },
                    { func: 'y=ln(3x)', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator">x</span></span>' },
                    { func: 'y=ln(x<sup>2</sup>)', derivative: '<span class="fraction"><span class="numerator">2</span><span class="denominator">x</span></span>' },
                    { func: 'y=ln(x<sup>3</sup>)', derivative: '<span class="fraction"><span class="numerator">3</span><span class="denominator">x</span></span>' },
                    { func: 'y=(2x+1)<sup>2</sup>', derivative: '4(2x+1)' },
                    { func: 'y=(3x+1)<sup>2</sup>', derivative: '6(3x+1)' },
                    { func: 'y=(x+1)<sup>3</sup>', derivative: '3(x+1)<sup>2</sup>' },
                    { func: 'y=(x+2)<sup>3</sup>', derivative: '3(x+2)<sup>2</sup>' },
                    { func: 'y=<span class="sqrt"><span class="sqrt-content">x+1</span></span>', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator">2<span class="sqrt"><span class="sqrt-content">x+1</span></span></span></span>' },
                    { func: 'y=<span class="sqrt"><span class="sqrt-content">x+2</span></span>', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator">2<span class="sqrt"><span class="sqrt-content">x+2</span></span></span></span>' },
                    { func: 'y=<span class="sqrt"><span class="sqrt-content">2x+1</span></span>', derivative: '<span class="fraction"><span class="numerator">1</span><span class="denominator"><span class="sqrt"><span class="sqrt-content">2x+1</span></span></span></span>' },
                    { func: 'y=sin(2x+1)', derivative: '2cos(2x+1)' },
                    { func: 'y=cos(3x+2)', derivative: '-3sin(3x+2)' },
                    { func: 'y=e<sup>2x+1</sup>', derivative: '2e<sup>2x+1</sup>' },
                    { func: 'y=ln(2x+1)', derivative: '<span class="fraction"><span class="numerator">2</span><span class="denominator">2x+1</span></span>' },
                    { func: 'y=ln(3x+2)', derivative: '<span class="fraction"><span class="numerator">3</span><span class="denominator">3x+2</span></span>' }
                ]
            },
            {
                id: 4,
                name: 'ÁªºÂêàÊåëÊàò',
                description: 'ÂâçÈù¢‰∏âÂÖ≥ÁöÑÁªºÂêàÁªÉ‰π†',
                pairs: [] // Â∞ÜÂú®ËøêË°åÊó∂Âä®ÊÄÅÁîüÊàê
            }
        ];

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let currentLevel = 1;
        let score = 0;
        let selectedCells = [];
        let matchedPairs = 0;
        let currentPairs = [];
        let gameCompleted = false;
        let health = 3;
        let gameFailed = false;
        let sameTypeMistakeCount = 0;
        let awaitingSameTypeConfirmation = false;
        let comboCount = 0;
        let lastMatchTime = 0;
        const COMBO_TIME_LIMIT = 3000;
        let timerInterval = null;
        let elapsedTime = 0;
        let timerRunning = false;
        let usedFunctions = {};
        
        // ÂÖ≥Âç°ËøõÂ∫¶ÁÆ°ÁêÜÔºà‰ΩøÁî®ÂÜÖÂ≠òÂèòÈáèÔºå‰∏ç‰øùÂ≠òÂà∞localStorageÔºåÂà∑Êñ∞ÂêéÈáçÁΩÆÔºâ
        let unlockedLevels = [1]; // ÂΩìÂâç‰ºöËØù‰∏≠Ëß£ÈîÅÁöÑÂÖ≥Âç°ÔºåÂàùÂßãÂè™ÊúâÁ¨¨‰∏ÄÂÖ≥
        let completedLevels = []; // ÂΩìÂâç‰ºöËØù‰∏≠ÂÆåÊàêÁöÑÂÖ≥Âç°
        
        // Êñ∞Â¢ûÔºöÂ≠òÂÇ®ÂêÑÂÖ≥Âç°ÁöÑÂæóÂàÜÂíåÁî®Êó∂
        let levelScores = [0, 0, 0, 0];
        let levelTimes = [0, 0, 0, 0];

        function getUnlockedLevels() {
            return unlockedLevels;
        }

        function unlockLevel(levelId) {
            // Âú®ÂΩìÂâç‰ºöËØù‰∏≠Ëß£ÈîÅÂÖ≥Âç°Ôºà‰∏ç‰øùÂ≠òÂà∞localStorageÔºâ
            if (!unlockedLevels.includes(levelId)) {
                unlockedLevels.push(levelId);
                unlockedLevels.sort((a, b) => a - b);
            }
        }

        function isLevelUnlocked(levelId) {
            return unlockedLevels.includes(levelId);
        }

        function getCompletedLevels() {
            return completedLevels;
        }

        function completeLevel(levelId) {
            // Âú®ÂΩìÂâç‰ºöËØù‰∏≠Ê†áËÆ∞ÂÖ≥Âç°‰∏∫Â∑≤ÂÆåÊàêÔºà‰∏ç‰øùÂ≠òÂà∞localStorageÔºâ
            if (!completedLevels.includes(levelId)) {
                completedLevels.push(levelId);
                
                // Â≠òÂÇ®ÂΩìÂâçÂÖ≥Âç°ÁöÑÂæóÂàÜÂíåÁî®Êó∂
                levelScores[levelId - 1] = score;
                levelTimes[levelId - 1] = elapsedTime;
            }
            // Ëß£ÈîÅ‰∏ã‰∏ÄÂÖ≥
            if (levelId < LEVELS.length) {
                unlockLevel(levelId + 1);
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÂÖ≥Âç°ÈÉΩÂ∑≤ÂÆåÊàê
            if (completedLevels.length === LEVELS.length) {
                // ÊòæÁ§∫Â•ñÂä±È°µÈù¢
                setTimeout(() => {
                    showRewardPage();
                }, 2000);
            }
        }

        function isLevelCompleted(levelId) {
            return completedLevels.includes(levelId);
        }

        // ÂàõÂª∫ËÉåÊôØÁ≤íÂ≠ê - ‰ºòÂåñÁâàÊú¨
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 15; // ÂáèÂ∞ëÁ≤íÂ≠êÊï∞Èáè
            
            function createParticleBatch() {
                for (let i = 0; i < particleCount; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.style.left = Math.random() * 100 + '%';
                        particle.style.top = Math.random() * 100 + '%';
                        particle.style.animationDelay = Math.random() * 15 + 's';
                        particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                        particlesContainer.appendChild(particle);
                    }, i * 50); // ÂàÜÊâπÂàõÂª∫
                }
            }
            
            // Âª∂ËøüÂàõÂª∫Á≤íÂ≠ê
            setTimeout(createParticleBatch, 1000);
        }

        // ÂàõÂª∫ÁàÜÁÇ∏Á≤íÂ≠êÊïàÊûú
        function createExplosion(x, y) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = x + 'px';
            explosion.style.top = y + 'px';
            document.body.appendChild(explosion);

            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'explosion-particle';
                const angle = (Math.PI * 2 * i) / 12;
                const distance = 50 + Math.random() * 30;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                particle.style.animationDelay = (i * 0.05) + 's';
                explosion.appendChild(particle);
            }

            setTimeout(() => {
                explosion.remove();
            }, 600);
        }

        // ÊòæÁ§∫ËøûÂáªÊèêÁ§∫
        function showCombo() {
            if (comboCount > 1) {
                const comboIndicator = document.getElementById('comboIndicator');
                comboIndicator.textContent = `${comboCount} ËøûÂáªÔºÅ`;
                comboIndicator.style.display = 'block';
                
                setTimeout(() => {
                    comboIndicator.style.display = 'none';
                }, 800);
            }
        }

        // ÊòæÁ§∫ÊàêÂ∞±
        function showAchievement(text) {
            const badge = document.getElementById('achievementBadge');
            badge.textContent = 'üèÜ ' + text;
            badge.style.display = 'block';
            
            setTimeout(() => {
                badge.style.display = 'none';
            }, 3000);
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        function updateProgress() {
            const progress = (matchedPairs / 8) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // ËÆ°Êó∂Áõ∏ÂÖ≥
        function formatTime(seconds) {
            const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return `${minutes}:${secs}`;
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer');
            if (!timerElement) return;
            timerElement.textContent = formatTime(elapsedTime);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerRunning = false;
        }

        function resumeTimer() {
            if (timerRunning) return;
            timerRunning = true;
            timerInterval = setInterval(() => {
                elapsedTime++;
                updateTimerDisplay();
            }, 1000);
        }

        // Ê∏≤ÊüìÂÖ≥Âç°ÈÄâÊã©ÁïåÈù¢
        function renderLevelSelect() {
            const levelGrid = document.getElementById('levelGrid');
            levelGrid.innerHTML = '';

            LEVELS.forEach(level => {
                const card = document.createElement('div');
                card.className = 'level-card';
                
                const isUnlocked = isLevelUnlocked(level.id);
                const isCompleted = isLevelCompleted(level.id);

                if (!isUnlocked) {
                    card.classList.add('locked');
                } else if (isCompleted) {
                    card.classList.add('completed');
                }

                card.innerHTML = `
                    ${!isUnlocked ? '<span class="level-lock-icon">üîí</span>' : ''}
                    <div class="level-number">${level.id}</div>
                    <div class="level-name">${level.name}</div>
                    <div class="level-description">${level.description}</div>
                    ${isCompleted ? '<div class="level-status">‚úì Â∑≤ÂÆåÊàê</div>' : ''}
                `;

                if (isUnlocked) {
                    card.addEventListener('click', () => {
                        startLevel(level.id);
                    });
                }

                levelGrid.appendChild(card);
            });
        }

        // ÂºÄÂßãÂÖ≥Âç°
        function startLevel(levelId) {
            currentLevel = levelId;
            score = 0;
            gameCompleted = false;
            gameFailed = false;
            health = 3;
            sameTypeMistakeCount = 0;
            awaitingSameTypeConfirmation = false;
            comboCount = 0;
            lastMatchTime = 0;
            pauseTimer();
            elapsedTime = 0;
            updateTimerDisplay();
            usedFunctions = {};
            
            document.getElementById('levelSelectScreen').classList.add('hidden');
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('score').textContent = '0';
            document.getElementById('backToLevelBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
            // Á°Æ‰øùËøîÂõûÊåâÈíÆÂßãÁªàÂèØËßÅ
            document.getElementById('gameBackToLevelBtn').style.display = 'block';
            document.getElementById('message').style.display = 'flex';
            document.getElementById('roundDescription').style.display = 'block';
            hideActionButtons();
            updateHealthBar();
            updateProgress();
            
            const level = LEVELS.find(l => l.id === levelId);
            document.getElementById('level').textContent = `ÂÖ≥Âç° ${levelId}`;
            document.getElementById('roundDescription').textContent = level.description;
            
            startRound();
        }

        // Ëé∑ÂèñÂΩìÂâçÂÖ≥Âç°ÁöÑÂáΩÊï∞ÂØπ
        function getLevelPairs() {
            const level = LEVELS.find(l => l.id === currentLevel);
            
            // Á¨¨ÂõõÂÖ≥ÔºöÊ∑∑ÂêàÂâçÈù¢‰∏âÂÖ≥ÁöÑÂÜÖÂÆπ
            if (currentLevel === 4) {
                const allPairs = [];
                // 30% Âü∫Êú¨ÂàùÁ≠âÂáΩÊï∞ (3ÂØπ)
                const level1Pairs = [...LEVELS[0].pairs].sort(() => Math.random() - 0.5).slice(0, 3);
                // 30% ÂõõÂàôËøêÁÆó (3ÂØπ)
                const level2Pairs = [...LEVELS[1].pairs].sort(() => Math.random() - 0.5).slice(0, 3);
                // 40% Â§çÂêàÂáΩÊï∞ (2ÂØπ)
                const level3Pairs = [...LEVELS[2].pairs].sort(() => Math.random() - 0.5).slice(0, 2);
                
                allPairs.push(...level1Pairs, ...level2Pairs, ...level3Pairs);
                return allPairs;
            }
            
            return level.pairs;
        }

        // ÂºÄÂßãÊñ∞ÁöÑ‰∏ÄËΩÆ
        function startRound() {
            if (gameFailed) {
                return;
            }

            sameTypeMistakeCount = 0;
            awaitingSameTypeConfirmation = false;
            hideActionButtons();

            const levelPairs = getLevelPairs();
            const levelKey = 'level' + currentLevel;
            
            // ËøáÊª§ÊéâÂ∑≤‰ΩøÁî®ÁöÑÂáΩÊï∞
            const availablePairs = levelPairs.filter(pair => {
                if (!usedFunctions[levelKey]) return true;
                return !usedFunctions[levelKey].includes(pair.func);
            });
            
            let candidates = availablePairs.length >= 8 ? availablePairs : levelPairs;
            
            // ÈöèÊú∫Êâì‰π±Âπ∂ÈÄâÊã©8ÂØπ
            const shuffledPairs = [...candidates].sort(() => Math.random() - 0.5);
            currentPairs = shuffledPairs.slice(0, 8);
            
            // ËÆ∞ÂΩïÊú¨Ê¨°‰ΩøÁî®ÁöÑÂáΩÊï∞
            if (!usedFunctions[levelKey]) {
                usedFunctions[levelKey] = [];
            }
            currentPairs.forEach(pair => {
                if (!usedFunctions[levelKey].includes(pair.func)) {
                    usedFunctions[levelKey].push(pair.func);
                }
            });

            // ÂàõÂª∫ÂáΩÊï∞ÂíåÂØºÊï∞ÁöÑÊï∞ÁªÑÔºå‰ΩÜÂàÜÂºÄÂ≠òÂÇ®
            let funcCells = [];
            let derivativeCells = [];
            
            currentPairs.forEach(pair => {
                funcCells.push({ text: pair.func, html: pair.func, type: 'func', pairId: pair.func });
                derivativeCells.push({ text: pair.derivative, html: pair.derivative, type: 'derivative', pairId: pair.func });
            });

            // ÂàÜÂà´Êâì‰π±ÂáΩÊï∞ÂíåÂØºÊï∞ÁöÑÈ°∫Â∫è
            funcCells = funcCells.sort(() => Math.random() - 0.5);
            derivativeCells = derivativeCells.sort(() => Math.random() - 0.5);
            
            // ÂêàÂπ∂Êï∞ÁªÑÔºöÂáΩÊï∞Âú®‰∏äÔºåÂØºÊï∞Âú®‰∏ã
            const cells = [...funcCells, ...derivativeCells];

            // Êõ¥Êñ∞UI
            renderGrid(cells);
            selectedCells = [];
            matchedPairs = 0;
            comboCount = 0;
            lastMatchTime = 0;
            updateRemaining();
            updateProgress();
            showMessage('ÁÇπÂáªÂáΩÊï∞ÂíåÂÖ∂ÂØπÂ∫îÁöÑÂØºÊï∞ËøõË°åÈÖçÂØπÊ∂àÈô§', 'info');
            resumeTimer();
        }

        // Ê∏≤ÊüìÁΩëÊ†º
        function renderGrid(cells) {
            const grid = document.getElementById('gameGrid');
            grid.innerHTML = '';
            
            // Ê∑ªÂä†ÂéüÂáΩÊï∞Ê†áÈ¢ò
            const funcTitle = document.createElement('div');
            funcTitle.style.gridColumn = 'span 4';
            funcTitle.style.textAlign = 'center';
            funcTitle.style.fontWeight = 'bold';
            funcTitle.style.marginBottom = '10px';
            funcTitle.style.color = '#1e90ff';
            funcTitle.style.fontSize = '18px';
            funcTitle.textContent = 'ÂéüÂáΩÊï∞';
            grid.appendChild(funcTitle);

            cells.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.className = 'cell';
                cellElement.innerHTML = cell.html || cell.text;
                cellElement.dataset.index = index;
                cellElement.dataset.type = cell.type;
                cellElement.dataset.pairId = cell.pairId;
                cellElement.style.animationDelay = (index * 0.05) + 's';
                cellElement.addEventListener('click', () => handleCellClick(cellElement, cell));
                grid.appendChild(cellElement);
                
                // Âú®Á¨¨8‰∏™ÂçïÂÖÉÊ†ºÂêéÊ∑ªÂä†ÂØºÊï∞Ê†áÈ¢ò
                if (index === 7) {
                    const derivativeTitle = document.createElement('div');
                    derivativeTitle.style.gridColumn = 'span 4';
                    derivativeTitle.style.textAlign = 'center';
                    derivativeTitle.style.fontWeight = 'bold';
                    derivativeTitle.style.margin = '10px 0';
                    derivativeTitle.style.color = '#ff6347';
                    derivativeTitle.style.fontSize = '18px';
                    derivativeTitle.textContent = 'ÂØºÊï∞';
                    grid.appendChild(derivativeTitle);
                }
            });
        }

        // Â§ÑÁêÜÂçïÂÖÉÊ†ºÁÇπÂáª
        function handleCellClick(element, cellData) {
            if (gameCompleted || gameFailed || awaitingSameTypeConfirmation) return;
            if (element.classList.contains('matched') || element.classList.contains('hidden')) return;
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedCells = selectedCells.filter(c => c.element !== element);
                return;
            }

            if (selectedCells.length >= 2) {
                selectedCells.forEach(c => c.element.classList.remove('selected'));
                selectedCells = [];
            }

            element.classList.add('selected');
            selectedCells.push({ element, data: cellData });

            if (selectedCells.length === 2) {
                checkMatch();
            }
        }

        // Ê£ÄÊü•ÂåπÈÖç
        function checkMatch() {
            const [first, second] = selectedCells;
            const firstData = first.data;
            const secondData = second.data;

            if (firstData.type === secondData.type) {
                awaitingSameTypeConfirmation = true;
                sameTypeMistakeCount++;
                if (sameTypeMistakeCount >= 3) {
                    showMessage('ËØ∑ÈáçÊñ∞‰ΩúÁ≠î', 'error');
                    showActionButton('retry');
                } else {
                    showMessage('ËØ∑ÂÖàÁÇπÂáªÂéüÂáΩÊï∞ ÂÜçÁÇπÂáª‰∏é‰πãÂåπÈÖçÁöÑÂØºÂáΩÊï∞', 'error');
                    showActionButton('continue');
                }
                return;
            }

            const isMatch = (
                (firstData.type === 'func' && secondData.type === 'derivative') ||
                (firstData.type === 'derivative' && secondData.type === 'func')
            ) && firstData.pairId === secondData.pairId;

            if (isMatch) {
                hideActionButtons();
                sameTypeMistakeCount = 0;
                
                const currentTime = Date.now();
                if (currentTime - lastMatchTime < COMBO_TIME_LIMIT) {
                    comboCount++;
                } else {
                    comboCount = 1;
                }
                lastMatchTime = currentTime;

                const rect1 = first.element.getBoundingClientRect();
                const rect2 = second.element.getBoundingClientRect();
                const x = (rect1.left + rect1.right) / 2;
                const y = (rect1.top + rect1.bottom) / 2;
                createExplosion(x, y);

                first.element.classList.add('matched');
                second.element.classList.add('matched');
                
                setTimeout(() => {
                    first.element.classList.add('hidden');
                    second.element.classList.add('hidden');
                }, 500);

                selectedCells = [];

                matchedPairs++;
                let baseScore = 12.5;
                let comboBonus = comboCount > 1 ? (comboCount - 1) * 2.5 : 0;
                score += baseScore + comboBonus;
                updateScore();
                updateRemaining();
                updateProgress();
                
                if (comboCount > 1) {
                    showCombo();
                    showMessage(`‚úì ÂåπÈÖçÊàêÂäüÔºÅ${comboCount} ËøûÂáª +${comboBonus.toFixed(1)}ÂàÜ`, 'success');
                } else {
                    showMessage('‚úì ÂåπÈÖçÊàêÂäüÔºÅ', 'success');
                }

                if (comboCount === 3) {
                    showAchievement('‰∏âËøûÂáªÔºÅ');
                } else if (comboCount === 5) {
                    showAchievement('‰∫îËøûÂáªÔºÅ');
                } else if (comboCount === 10) {
                    showAchievement('ÂçÅËøûÂáªÔºÅÂ§ßÂ∏àÔºÅ');
                }

                if (matchedPairs === 8) {
                    setTimeout(() => {
                        finishLevel();
                    }, 1000);
                }
            } else {
                hideActionButtons();
                sameTypeMistakeCount = 0;
                comboCount = 0;
                lastMatchTime = 0;
                decreaseHealth();
                
                if (gameFailed) {
                    return;
                }
                
                showMessage('‚úó ‰∏çÂåπÈÖçÔºåËØ∑ÈáçËØï', 'error');
                setTimeout(() => {
                    first.element.classList.remove('selected');
                    second.element.classList.remove('selected');
                    selectedCells = [];
                }, 1000);
            }
        }

        // ÂÆåÊàêÂÖ≥Âç°
        function finishLevel() {
            pauseTimer();
            gameCompleted = true;
            completeLevel(currentLevel);
            const grid = document.getElementById('gameGrid');
            grid.innerHTML = `
                <div class="game-complete" style="grid-column: 1 / -1;">
                    <h2>üéâ ÂÖ≥Âç°ÂÆåÊàêÔºÅ</h2>
                    <p>ÊÅ≠Âñú‰Ω†ÂÆåÊàê‰∫ÜÂÖ≥Âç° ${currentLevel}ÔºÅ</p>
                    <p>ÂæóÂàÜÔºö${formatScore(score)} ÂàÜ</p>

                    <p>Áî®Êó∂Ôºö${formatTime(elapsedTime)}</p>
                    <button class="button" id="backToLevelBtn2" style="margin-top: 20px;">&lt; ËøîÂõû</button>
                </div>
            `;
            hideActionButtons();
            document.getElementById('message').style.display = 'none';
            document.getElementById('roundDescription').style.display = 'none';
            
            document.getElementById('backToLevelBtn2').addEventListener('click', () => {
                backToLevelSelect();
            });
        }

        // ÊòæÁ§∫Â•ñÂä±È°µÈù¢
        function showRewardPage() {
            // ËÆ°ÁÆóÊÄªÂæóÂàÜÂíåÊÄªÁî®Êó∂
            const totalScore = levelScores.reduce((sum, score) => sum + score, 0);
            const totalTime = levelTimes.reduce((sum, time) => sum + time, 0);
            
            // Êõ¥Êñ∞Â•ñÂä±È°µÈù¢ÁöÑÁªüËÆ°‰ø°ÊÅØ
            document.getElementById('rewardLevels').textContent = `${completedLevels.length}/${LEVELS.length}`;
            document.getElementById('rewardScore').textContent = formatScore(totalScore);
            document.getElementById('rewardTime').textContent = formatTime(totalTime);
            
            // ÊòæÁ§∫Â•ñÂä±È°µÈù¢
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('rewardScreen').classList.remove('hidden');
        }

        // Êõ¥Êñ∞Ââ©‰ΩôÈÖçÂØπ
        function updateRemaining() {
            const remaining = 8 - matchedPairs;
            document.getElementById('remaining').textContent = remaining;
        }

        // Êõ¥Êñ∞ÂæóÂàÜ
        function formatScore(value) {
            return (Math.round(value) === value) ? String(value) : value.toFixed(1);
        }

        function updateScore() {
            const scoreElement = document.getElementById('score');
            scoreElement.textContent = formatScore(score);
            scoreElement.classList.add('animate');
            setTimeout(() => {
                scoreElement.classList.remove('animate');
            }, 500);
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
        }

        // Êõ¥Êñ∞Ë°ÄÊù°ÊòæÁ§∫
        function updateHealthBar() {
            const healthBar = document.getElementById('healthBar');
            healthBar.innerHTML = '';
            for (let i = 0; i < health; i++) {
                const heart = document.createElement('span');
                heart.className = 'health-heart full';
                heart.textContent = '‚ù§Ô∏è';
                healthBar.appendChild(heart);
            }
        }

        // ÂáèÂ∞ëÁîüÂëΩÂÄº
        function decreaseHealth() {
            health--;
            updateHealthBar();
            
            if (health <= 0) {
                gameFailed = true;
                showGameFailed();
            }
        }

        function showActionButton(type) {
            const continueBtn = document.getElementById('continueBtn');
            const retryBtn = document.getElementById('retryRoundBtn');
            continueBtn.style.display = type === 'continue' ? 'inline-block' : 'none';
            retryBtn.style.display = type === 'retry' ? 'inline-block' : 'none';
        }

        function hideActionButtons() {
            const continueBtn = document.getElementById('continueBtn');
            const retryBtn = document.getElementById('retryRoundBtn');
            continueBtn.style.display = 'none';
            retryBtn.style.display = 'none';
            awaitingSameTypeConfirmation = false;
        }

        // ÊòæÁ§∫Ê∏∏ÊàèÂ§±Ë¥•ÁïåÈù¢
        function showGameFailed() {
            pauseTimer();
            const grid = document.getElementById('gameGrid');
            grid.innerHTML = `
                <div class="game-failed" style="grid-column: 1 / -1;">
                    <h2>üò¢ ÂØπ‰∏çËµ∑ÔºåÊÇ®Â§±Ë¥•‰∫Ü</h2>
                    <p>ÂΩìÂâçÂæóÂàÜÔºö${formatScore(score)} ÂàÜ</p>

                    <p>ÊÄªÁî®Êó∂Ôºö${formatTime(elapsedTime)}</p>
                    <button class="button" id="retryBtn" style="margin-top: 20px;">ÈáçÊñ∞ÊåëÊàò</button>
                </div>
            `;
            hideActionButtons();
            document.getElementById('message').style.display = 'none';
            document.getElementById('roundDescription').style.display = 'none';
            
            document.getElementById('retryBtn').addEventListener('click', () => {
                document.getElementById('message').style.display = 'flex';
                document.getElementById('roundDescription').style.display = 'block';
                startLevel(currentLevel);
            });
        }

        // ËøîÂõûÂÖ≥Âç°ÈÄâÊã©
        function backToLevelSelect() {
            // Â¶ÇÊûúÊ∏∏ÊàèÊ≠£Âú®ËøõË°å‰∏≠ÔºåËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶Á°ÆËÆ§ËøîÂõû
            if (!gameCompleted && !gameFailed && matchedPairs < 8) {
                if (!confirm('Á°ÆÂÆöË¶ÅËøîÂõûÂÖ≥Âç°ÈÄâÊã©ÂêóÔºüÂΩìÂâçËøõÂ∫¶Â∞Ü‰∏ç‰ºö‰øùÂ≠ò„ÄÇ')) {
                    return;
                }
            }
            pauseTimer();
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('levelSelectScreen').classList.remove('hidden');
            renderLevelSelect();
        }

        // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
        function bindEvents() {
            document.getElementById('continueBtn').addEventListener('click', () => {
                hideActionButtons();
                selectedCells.forEach(c => c.element.classList.remove('selected'));
                selectedCells = [];
                showMessage('ËØ∑ÁªßÁª≠‰ΩúÁ≠îÔºåÂÖàÈÄâÊã©ÂéüÂáΩÊï∞ÔºåÂÜçÈÄâÊã©ÂØºÂáΩÊï∞', 'info');
            });
            
            document.getElementById('retryRoundBtn').addEventListener('click', () => {
                hideActionButtons();
                selectedCells.forEach(c => c.element.classList.remove('selected'));
                selectedCells = [];
                sameTypeMistakeCount = 0;
                const levelKey = 'level' + currentLevel;
                if (usedFunctions[levelKey]) {
                    usedFunctions[levelKey] = [];
                }
                showMessage('ËØ∑ÈáçÊñ∞‰ΩúÁ≠î', 'info');
                startRound();
            });

            document.getElementById('backToLevelBtn').addEventListener('click', backToLevelSelect);
            
            // ÁªëÂÆöÊ∏∏Êàè‰∏≠ÁöÑËøîÂõûÊåâÈíÆ
            document.getElementById('gameBackToLevelBtn').addEventListener('click', backToLevelSelect);

            // ÂºÄÂßãÁïåÈù¢
            document.getElementById('startButton').addEventListener('click', handleStart);

            document.getElementById('backToStartBtn').addEventListener('click', () => {
                document.getElementById('levelSelectScreen').classList.add('hidden');
                document.getElementById('startScreen').style.display = 'flex';
                document.getElementById('startScreen').classList.remove('hidden');
            });

            // Â•ñÂä±È°µÈù¢ÊåâÈíÆ
            document.getElementById('rewardBackButton').addEventListener('click', () => {
                document.getElementById('rewardScreen').classList.add('hidden');
                document.getElementById('levelSelectScreen').classList.remove('hidden');
                renderLevelSelect();
            });

            document.getElementById('shareButton').addEventListener('click', () => {
                // Ê®°ÊãüÂàÜ‰∫´ÂäüËÉΩ
                alert('ÂàÜ‰∫´ÂäüËÉΩÂ∑≤Ëß¶ÂèëÔºÅÊÇ®ÂèØ‰ª•ÈÄöËøáÂ§çÂà∂ÈìæÊé•‰∏éÊúãÂèãÂàÜ‰∫´ÊÇ®ÁöÑÊàêÂ∞±ÔºÅ');
            });
        }

        function handleStart() {
            const startScreen = document.getElementById('startScreen');
            startScreen.classList.add('hidden');
            setTimeout(() => {
                startScreen.style.display = 'none';
                document.getElementById('levelSelectScreen').classList.remove('hidden');
                createParticles();
                renderLevelSelect();
            }, 500);
        }

        // ÂàùÂßãÂåñÁ≤íÂ≠ê
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                bindEvents();
                createParticles();
            }, 100);
        });
    </script>
</body>
</html>
